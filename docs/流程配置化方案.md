# 备案管理系统 - 流程配置化方案

## 一、方案概述

通过注解 + AOP 实现业务方法与工作流的自动化关联，无需在业务代码中硬编码流程调用。

## 二、核心设计

```
业务方法调用 ──► @DeclareProcess 注解标记 ──► AOP 拦截 ──► 查询流程配置 ──► 启动流程
```

## 三、businessType 命名规则

```
{模块名}:{业务名}:{动作}
示例：declare:filing:submit
```

| 组成部分 | 规则 | 示例 |
|---------|------|------|
| 模块名 | controller 路径第一部分 | `declare` |
| 业务名 | 类名（去掉 Controller 后缀） | `filing` |
| 动作名 | 方法名 | `submit` |

## 四、新增表结构

### 1. declare_business_type（业务类型与流程关联配置表）

```sql
CREATE TABLE `declare_business_type` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `business_type` varchar(128) NOT NULL COMMENT '业务类型（declare:filing:submit）',
  `business_name` varchar(64) NOT NULL COMMENT '业务名称（备案提交）',
  `process_definition_key` varchar(64) NOT NULL COMMENT '流程定义Key',
  `process_category` varchar(32) NOT NULL COMMENT '流程分类（declare_filing）',
  `description` varchar(512) DEFAULT '' COMMENT '描述',
  `enabled` tinyint(4) NOT NULL DEFAULT 1 COMMENT '是否启用（0=禁用，1=启用）',
  `sort` int(11) NOT NULL DEFAULT 0 COMMENT '排序',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `idx_business_type`(`business_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='业务类型与流程关联配置表';
```

### 2. declare_business_process（业务与流程实例关联表）

```sql
CREATE TABLE `declare_business_process` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `business_type` varchar(128) NOT NULL COMMENT '业务类型',
  `business_id` bigint(20) NOT NULL COMMENT '业务ID',
  `process_instance_id` varchar(64) NOT NULL COMMENT '流程实例ID',
  `process_definition_key` varchar(64) NOT NULL COMMENT '流程定义Key',
  `current_node_key` varchar(64) DEFAULT '' COMMENT '当前节点Key',
  `current_status` varchar(32) DEFAULT '' COMMENT '当前流程状态',
  `initiator_id` bigint(20) DEFAULT NULL COMMENT '发起人ID',
  `start_time` datetime NOT NULL COMMENT '流程开始时间',
  `end_time` datetime DEFAULT NULL COMMENT '流程结束时间',
  `result` varchar(32) DEFAULT '' COMMENT '流程结果（agree=通过，reject=驳回）',
  PRIMARY KEY (`id`),
  UNIQUE INDEX `idx_business`(`business_type`, `business_id`),
  INDEX `idx_process_instance`(`process_instance_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='业务与流程实例关联表';
```

## 五、配置示例

```sql
-- 备案相关流程
INSERT INTO `declare_business_type` (`business_type`, `business_name`, `process_definition_key`, `process_category`, `enabled`) VALUES
('declare:filing:submit', '备案提交', 'proc_filing', 'declare_filing', 1),
('declare:filing:audit', '备案审核', 'proc_filing_audit', 'declare_filing', 1),
('declare:filing:withdraw', '备案撤回', 'proc_filing_withdraw', 'declare_filing', 1),
('declare:filing:resubmit', '重新提交', 'proc_filing_resubmit', 'declare_filing', 1),

-- 项目相关流程
('declare:project:start', '项目立项', 'proc_project', 'declare_project', 1),
('declare:project:midterm', '中期评估', 'proc_midterm', 'declare_project', 1),

-- 成果相关流程
('declare:achievement:submit', '成果提交', 'proc_achievement', 'declare_achievement', 0),
('declare:achievement:audit', '成果审核', 'proc_achievement_audit', 'declare_achievement', 0);
```

## 六、使用方式

### 6.1 自动解析 businessType

```java
@DeclareProcess
public CommonResult<Boolean> submitFiling(@RequestParam("id") Long id) {
    filingService.submitFiling(id);
    return success(true);
}
// 自动解析为：declare:filing:submit
```

### 6.2 手动指定 businessType

```java
@DeclareProcess(businessType = "declare:filing:resubmit")
public CommonResult<Boolean> resubmitFiling(@RequestParam("id") Long id) {
    filingService.resubmitFiling(id);
    return success(true);
}
```

### 6.3 可选流程（没有配置就跳过）

```java
@DeclareProcess(required = false)
public CommonResult<Boolean> withdrawFiling(@RequestParam("id") Long id) {
    filingService.withdrawFiling(id);
    return success(true);
}
// 如果没有配置 declare:filing:withdraw，不会报错
```

### 6.4 必须流程（没有配置则抛异常）

```java
@DeclareProcess(required = true)
public CommonResult<Boolean> submitFiling(@RequestParam("id") Long id) {
    filingService.submitFiling(id);
    return success(true);
}
// 如果没有配置 declare:filing:submit，会抛出异常
```

## 七、流程执行流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    自动化流程识别与执行机制                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 业务方法调用                                                         │
│     ┌────────────────────────────────────┐                              │
│     │ FilingController.submitFiling(id) │                              │
│     └────────────┬─────────────────────┘                              │
│                  │                                                      │
│                  ▼                                                      │
│  2. AOP 拦截                                                         │
│     ┌──────────────────────────────────────────┐                        │
│     │ @DeclareProcess 注解标记                  │                        │
│     │ 自动解析 businessType = "declare:filing:submit" │                │
│     └────────────┬───────────────────────────┘                         │
│                  │                                                      │
│                  ▼                                                      │
│  3. 查询流程配置                                                         │
│     ┌──────────────────────────────────────────┐                        │
│     │ SELECT * FROM declare_business_type      │                        │
│     │ WHERE business_type = 'declare:filing:submit' │                   │
│     │                                              │                        │
│     │ 结果1: 有配置 (proc_filing, enabled=1)    │                        │
│     │ 结果2: 无配置                               │                        │
│     │ 结果3: 有配置但 disabled                    │                        │
│     └────────────┬───────────────────────────┘                          │
│                  │                                                      │
│         ┌───────┴───────┬───────┐                                      │
│         │               │       │                                       │
│         ▼               ▼       ▼                                       │
│   ┌───────────┐   ┌─────────┐ ┌───────────┐                           │
│   │ 有配置启用 │   │ 无配置   │ │ 有配置禁用 │                           │
│   └─────┬─────┘   └────┬────┘ └─────┬─────┘                           │
│         │              │            │                                   │
│         ▼              │            ▼                                   │
│   ┌───────────┐        │      ┌─────────┐                              │
│   │ 启动流程   │        │      │ 跳过流程 │                              │
│   │ 更新关联表  │        │      │ 继续执行业务 │                          │
│   └─────┬─────┘        │      └────┬────┘                              │
│         │              │             │                                  │
│         └──────────────┴─────────────┘                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 八、核心代码结构

```
module-declare/
├── dal/
│   ├── dataobject/
│   │   └── process/
│   │       ├── DeclareBusinessTypeDO.java      # 业务类型配置实体
│   │       └── DeclareBusinessProcessDO.java   # 业务流程关联实体
│   └── mysql/
│       └── process/
│           ├── DeclareBusinessTypeMapper.java   # 配置 Mapper
│           └── DeclareBusinessProcessMapper.java # 关联 Mapper
├── framework/
│   └── process/
│       ├── annotation/
│       │   └── DeclareProcess.java             # 流程注解
│       ├── aspect/
│       │   └── DeclareProcessAspect.java       # AOP 切面
│       └── service/
│           ├── DeclareProcessService.java       # 服务接口
│           └── impl/
│               └── DeclareProcessServiceImpl.java # 服务实现
└── controller/
    └── admin/
        └── filing/
            └── FilingController.java           # 备案 Controller（示例）
```

## 九、业务 Service 改造

### 改造前

```java
public class FilingServiceImpl implements FilingService {
    @Resource
    private RuntimeService runtimeService;

    @Override
    public void submitFiling(Long id) {
        // 更新业务状态
        filing.setFilingStatus(SUBMITTED);
        filingMapper.updateById(filing);

        // 手动启动流程（写死了！）
        runtimeService.startProcessInstanceByKey("proc_filing", id.toString());
    }
}
```

### 改造后

```java
public class FilingServiceImpl implements FilingService {
    @Override
    public void submitFiling(Long id) {
        // 只更新业务状态
        filing.setFilingStatus(SUBMITTED);
        filingMapper.updateById(filing);

        // 流程由 @DeclareProcess AOP 自动启动
        // 无需手动调用流程服务
    }
}
```

## 十、优势总结

| 优势 | 说明 |
|------|------|
| **配置化** | 流程与业务解耦，通过配置表管理 |
| **自动化** | 自动解析 businessType，自动启动流程 |
| **零侵入** | 只需加注解，无需修改业务逻辑 |
| **灵活性** | 支持可选流程和必须流程 |
| **可追溯** | 记录业务流程关联关系 |

## 十一、注意事项

1. **流程配置** - 必须在 `declare_business_type` 表中配置对应的 businessType
2. **流程定义** - 对应的流程定义（bpmn 文件）必须已部署到 Flowable
3. **权限控制** - 流程任务的审批权限需要在流程设计器中配置
4. **状态更新** - 流程完成后由监听器回调更新业务状态
